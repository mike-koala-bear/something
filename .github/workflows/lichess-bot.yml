name: Run Botli Hybrid Tournament → Matchmaking

on:
  workflow_dispatch:
    inputs:
      upgrade:
        description: "Upgrade to a Lichess bot account?"
        required: false
        type: boolean
        default: "false"
      matchmaking:
        description: "Enable matchmaking before tournament starts?"
        required: false
        type: boolean
        default: "true"
      tournament_id:
        description: "Tournament ID to auto-join"
        required: false
        default: ""
      tournament_wait:
        description: "Max seconds to wait before tournament starts (for matchmaking)"
        required: false
        default: "60"
      tournament_duration:
        description: "Tournament duration in minutes"
        required: false
        default: "20"
      additional_command:
        description: "Optional commands to pass"
        required: false
        default: ""
      never_stop:
        description: "Never stop matchmaking unless it stops itself"
        required: false
        type: boolean
        default: "true"

permissions:
  actions: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 355
    env:
      LICHESS_TOKEN: ${{ secrets.LICHESS_TOKEN }}
      PRIVATE_CONFIG_TOKEN: ${{ secrets.PRIVATE_CONFIG_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-runs@v0.14.0
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}
          workflow_id: lichess-bot.yml
          cancel_in_progress: true
          cancel_queued: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Copy Private Config
        uses: actions/checkout@v5
        with:
          repository: mike-koala-bear/tacticalbot-config
          token: ${{ secrets.PRIVATE_CONFIG_TOKEN }}
          path: tacticalbot-config

      - name: Inject Lichess Token into Config
        run: |
          if [ -f tacticalbot-config/config.yml ]; then
            cp tacticalbot-config/config.yml ./config.yml
            sed -i "s/tokenXXXXX/${{ secrets.LICHESS_TOKEN }}/g" config.yml
            echo "✅ Config copied and token injected"
          else
            echo "❌ tacticalbot-config/config.yml not found!"
            exit 1
          fi

      - name: Join Tournament (if provided)
        if: ${{ github.event.inputs.tournament_id != '' }}
        run: |
          TOURNAMENT_ID="${{ github.event.inputs.tournament_id }}"
          echo "Joining tournament $TOURNAMENT_ID..."
          curl -s -X POST -H "Authorization: Bearer $LICHESS_TOKEN" \
            https://lichess.org/api/tournament/$TOURNAMENT_ID/join
          echo "✅ Tournament join request sent"

      - name: Run Bot with Hybrid Mode
        run: |
          echo "Starting bot..."
          UPGRADE="${{ github.event.inputs.upgrade }}"
          MATCHMAKING="${{ github.event.inputs.matchmaking }}"
          ADDITIONAL_CMD=${{ toJSON(github.event.inputs.additional_command) }}
          TOURNAMENT_ID="${{ github.event.inputs.tournament_id }}"
          TOURNAMENT_WAIT="${{ github.event.inputs.tournament_wait }}"
          TOURNAMENT_DURATION="${{ github.event.inputs.tournament_duration }}"

          # Start matchmaking while waiting for tournament
          if [ "$MATCHMAKING" = "true" ] && [ "$TOURNAMENT_ID" != "" ]; then
            echo "Playing matchmaking while waiting for tournament..."
            python3 -u user_interface.py matchmaking &
            MM_PID=$!
          fi

          # Wait for tournament to start
          if [ "$TOURNAMENT_ID" != "" ]; then
            START=$(date +%s)
            while true; do
              STATUS=$(curl -s -H "Authorization: Bearer $LICHESS_TOKEN" \
                "https://lichess.org/api/tournament/$TOURNAMENT_ID" | jq -r '.status')
              NOW=$(date +%s)
              ELAPSED=$((NOW-START))
              if [ "$STATUS" == "started" ]; then
                echo "Tournament started!"
                break
              elif [ "$ELAPSED" -ge "$TOURNAMENT_WAIT" ]; then
                echo "Tournament not started within wait time. Stopping matchmaking..."
                [ -n "$MM_PID" ] && kill -SIGTERM $MM_PID
                break
              fi
              sleep 5
            done
          fi

          # Kill matchmaking if still running
          [ -n "$MM_PID" ] && kill -SIGTERM $MM_PID || true

          # Run bot in tournament mode
          if [ "$TOURNAMENT_ID" != "" ]; then
            CMD="python3 -u user_interface.py"
            [ "$UPGRADE" = "true" ] && CMD="$CMD --upgrade"
            [ -n "$ADDITIONAL_CMD" ] && CMD="$CMD $ADDITIONAL_CMD"
            CMD="$CMD tournament $TOURNAMENT_ID"
            echo "Running tournament bot: $CMD"
            eval "$CMD" &
            BOT_PID=$!

            # Watch tournament duration
            (
              SECONDS=$((TOURNAMENT_DURATION * 60))
              END=$((SECONDS + $(date +%s)))
              while kill -0 $BOT_PID 2>/dev/null; do
                NOW=$(date +%s)
                if [ "$NOW" -ge "$END" ]; then
                  echo "Tournament duration reached. Leaving after current game..."
                  python3 user_interface.py leave_tournament "$TOURNAMENT_ID"
                  kill -SIGTERM $BOT_PID
                  break
                fi
                sleep 10
              done
            ) &

            wait $BOT_PID
            echo "Tournament finished."
          fi

          # Start post-tournament matchmaking automatically
          if [ "$MATCHMAKING" = "true" ]; then
            echo "Starting post-tournament matchmaking..."
            python3 -u user_interface.py matchmaking
          fi
