name: Lichess Bot Team Battle

on:
  workflow_dispatch:
    inputs:
      tournament_id:
        description: "Tournament ID to auto-join"
        required: true
      team_id:
        description: "Team ID for the battle"
        required: true
      additional_command:
        description: "Optional commands to pass (wrap in quotes)"
        required: false
        default: ""
      never_stop:
        description: "Never stop matchmaking unless it stops itself"
        required: false
        type: boolean
        default: true

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install system tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Install Python deps
        run: |
          pip install -r requirements.txt

      - name: Clone Private Config Repo
        uses: actions/checkout@v5
        with:
          repository: mike-koala-bear/tacticalbot-config
          token: ${{ secrets.PRIVATE_CONFIG_TOKEN }}
          path: tacticalbot-config

      - name: Copy Private Config
        run: |
          if [ -f tacticalbot-config/config.yml ]; then
            cp tacticalbot-config/config.yml ./config.yml
            echo "✅ config.yml copied"
          else
            echo "❌ config.yml not found in tacticalbot-config repo"
            exit 1
          fi

      - name: Inject Bot Token
        run: |
          if grep -q "tokenXXXXX" config.yml; then
            sed -i "s/tokenXXXXX/${{ secrets.LICHESS_TOKEN }}/g" config.yml
            echo "✅ token injected into config.yml"
          else
            echo "⚠️ token placeholder not found in config.yml — ensure config uses tokenXXXXX or set LICHESS_TOKEN env."
          fi

      - name: Start bot and join team battle
        env:
          LICHESS_TOKEN: ${{ secrets.LICHESS_TOKEN }}
        run: |
          set -euo pipefail
          echo "Starting bot..."

          TOURNAMENT_ID="${{ github.event.inputs.tournament_id }}"
          TEAM_ID="${{ github.event.inputs.team_id }}"
          ADDITIONAL_CMD=${{ toJSON(github.event.inputs.additional_command) }}
          CONFIG_FILE="./config.yml"

          if [ -z "$LICHESS_TOKEN" ]; then
            echo "❌ LICHESS_TOKEN not set. Aborting."
            exit 1
          fi

          # 1️⃣ Check currently joined tournaments
          echo "Fetching tournaments currently playing..."
          playing_json=$(curl -sS -H "Authorization: Bearer $LICHESS_TOKEN" \
            https://lichess.org/api/account/playing)

          echo "Currently joined tournaments:"
          echo "$playing_json" | jq

          # 2️⃣ Leave all tournaments (optional, remove if not desired)
          for tid in $(echo "$playing_json" | jq -r '.nowPlaying[].id'); do
            echo "Leaving tournament $tid..."
            curl -sS -X POST -H "Authorization: Bearer $LICHESS_TOKEN" \
              "https://lichess.org/api/tournament/$tid/leave"
          done

          # 3️⃣ Join the team battle
          echo "Joining team battle $TOURNAMENT_ID / $TEAM_ID..."
          join_resp=$(curl -sS -X POST -H "Authorization: Bearer $LICHESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"teamId\":\"$TEAM_ID\"}" \
            "https://lichess.org/api/tournament/$TOURNAMENT_ID/join")

          echo "Join response:"
          echo "$join_resp"

          # 4️⃣ Launch BotLi in tournament mode
          echo "Launching BotLi..."
          CMD="python3 -u user_interface.py --config $CONFIG_FILE tournament $TOURNAMENT_ID $TEAM_ID"
          [ -n "$ADDITIONAL_CMD" ] && CMD="$CMD $ADDITIONAL_CMD"
          echo "CMD: $CMD"
          eval "$CMD"
