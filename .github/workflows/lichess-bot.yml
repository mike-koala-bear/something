name: Lichess Bot

on:
  push:
    branches: [main, master]
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

env:
  LICHESS_TOKEN: ${{ secrets.LICHESS_TOKEN }}

jobs:
  deploy-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    # Removed matrix strategy to run single instance
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tenacity  # Adding missing dependency

      # - name: Download latest Stockfish dev
      #   run: |
      #     mkdir -p engines
      #     sudo apt-get update && sudo apt-get install -y unzip
      #     curl -L -o stockfish.zip http://abrok.eu/stockfish/latest/linux/stockfish_x64_modern.zip
      #     unzip -o stockfish.zip -d engines/
      #     mv engines/stockfish_* engines/sf
      #     chmod +x engines/sf

      - name: Setup engines permissions
        run: |
          if [ -f "engines/fairy-stockfish-largeboard_x86-64" ]; then
            chmod +x engines/fairy-stockfish-largeboard_x86-64
          fi
          if [ -f "engines/stockfish-ubuntu-x86-64-avx2" ]; then
            chmod +x engines/stockfish-ubuntu-x86-64-avx2
          fi

      - name: Setup token
        run: |
          python3 << 'EOF'
          import yaml
          try:
              with open('config.yml', 'r') as f:
                  config = yaml.safe_load(f) or {}
              config['token'] = "${{ secrets.LICHESS_KEY }}"
              with open('config.yml', 'w') as f:
                  yaml.dump(config, f, default_flow_style=False)
              print("âœ… Token configuration successful")
          except Exception as e:
              print(f"âŒ Error: {e}")
              exit(1)
          EOF

      - name: Launch bot
        timeout-minutes: 340
        run: |
          echo "ðŸ¤– Starting bot..."
          python3 user_interface.py -u "tournament F2Flw2sl"
